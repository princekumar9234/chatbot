<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="AI Chatbot Assistant - Interactive chatbot with rule-based responses"
    />
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/user_profile.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Background Animation -->
    <div class="background-animation">
      <div class="circle circle-1"></div>
      <div class="circle circle-2"></div>
      <div class="circle circle-3"></div>
    </div>

    <!-- Main Container -->
    <div class="container">
      <!-- Header -->
      <header class="chat-header">
        <div class="header-content">
          <div class="bot-avatar">
            <img src="/images/logo.jpg" alt="Bot Logo" />
          </div>
        <div class="header-info">
            <h1 class="bot-name">Arise</h1>
            <p class="bot-status">
              <span class="status-indicator"></span>
              Online
            </p>
          </div>
          <% if (typeof user !== 'undefined' && user) { %>
          <div class="user-controls">
            <!-- Profile Trigger -->
            <div class="user-profile-pill" onclick="openProfileModal()" title="Open Profile">
              <div class="user-img-container">
                <img src="<%= user.profileImage || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random&color=fff' %>" alt="User" />
              </div>
            </div>
            
            <!-- Logout Button -->
            <a href="/auth/logout" class="logout-icon-btn" title="Logout">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M15 12L2 12M2 12L6 16M2 12L6 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M13 4H19C20.1046 4 21 4.89543 21 6V18C21 19.1046 20.1046 20 19 20H13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </a>
          </div>
          <% } %>
        </div>
      </header>

      <!-- Profile/Settings Modal -->
      <% if (typeof user !== 'undefined' && user) { %>
      <div id="profileModal" class="profile-modal-overlay" style="display: none;">
        <div class="profile-modal-content">
          
          <!-- View Mode -->
          <div id="profileViewMode">
            <div class="modal-header">
              <button class="back-btn" onclick="closeProfileModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
              </button>
              <h3>Settings</h3>
              <div style="width: 24px;"></div> <!-- Spacer -->
            </div>
            
            <div class="profile-summary">
              <div class="profile-summary-avatar">
                 <img src="<%= user.profileImage || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random&color=fff' %>" alt="User" />
              </div>
              <h2 class="profile-display-name"><%= user.displayName || user.username %></h2>
              <p class="profile-handle"><%= user.username %></p>
              
              <button class="edit-profile-btn" onclick="toggleEditMode(true)">Edit profile</button>
            </div>
  
            <div class="settings-group">
              <div class="group-title">My ChatBot</div>
              <div class="settings-item">
                <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/></svg></div>
                <div class="item-text">Personalization</div>
              </div>
              <div class="settings-item">
                <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></div>
                <div class="item-text">Apps</div>
              </div>
            </div>
  
            <div class="settings-group">
              <div class="group-title">Account</div>
              <div class="settings-item">
                 <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
                 <div class="item-text">
                    <div class="main-text">Workspace</div>
                    <div class="sub-text">Personal</div>
                 </div>
              </div>
              <div class="settings-item">
                 <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
                 <div class="item-text">Upgrade to Plus</div>
              </div>
              <div class="settings-item">
                 <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg></div>
                 <div class="item-text">
                    <div class="main-text">Subscription</div>
                    <div class="sub-text">Free Plan</div>
                 </div>
              </div>
              <div class="settings-item">
                 <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>
                 <div class="item-text">
                    <div class="main-text">Email</div>
                    <div class="sub-text"><%= user.email || 'Not set' %></div>
                 </div>
              </div>
               <div class="settings-item">
                 <div class="item-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg></div>
                 <div class="item-text">provider: <%= (user.googleId ? 'Google' : (user.githubId ? 'GitHub' : 'Email')) %></div>
              </div>
            </div>
          </div>

          <!-- Edit Mode -->
          <div id="profileEditMode" style="display: none;">
             <div class="modal-header">
              <button class="back-btn" onclick="toggleEditMode(false)">Cancel</button>
              <h3>Edit Profile</h3>
              <button class="save-btn" onclick="saveProfile()">Save</button>
            </div>
            
            <form id="editProfileForm" class="edit-form">
               <div class="form-group">
                  <label>Profile Picture</label>
                  <div class="edit-avatar">
                     <img src="<%= user.profileImage || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random&color=fff' %>" alt="User" />
                     <div class="change-photo-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></div>
                  </div>
               </div>
               
               <div class="form-group">
                  <label>Display Name</label>
                  <input type="text" name="displayName" value="<%= user.displayName || user.username %>" placeholder="Enter your name" />
               </div>

               <div class="form-group">
                  <label>Email</label>
                  <input type="email" name="email" value="<%= user.email || '' %>" placeholder="Enter your email" />
               </div>

               <p class="form-note">Username cannot be changed.</p>
            </form>
          </div>

        </div>
      </div>

      <script>
        function openProfileModal() {
          const modal = document.getElementById('profileModal');
          if(modal) {
             modal.style.display = 'flex';
             setTimeout(() => modal.classList.add('show'), 10);
          }
        }

        function closeProfileModal() {
          const modal = document.getElementById('profileModal');
          if(modal) {
             modal.classList.remove('show');
             setTimeout(() => modal.style.display = 'none', 300);
          }
        }

        function toggleEditMode(showEdit) {
           document.getElementById('profileViewMode').style.display = showEdit ? 'none' : 'block';
           document.getElementById('profileEditMode').style.display = showEdit ? 'block' : 'none';
        }

        async function saveProfile() {
            const btn = document.querySelector('.save-btn');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;

            const form = document.getElementById('editProfileForm');
            const data = {
                displayName: form.displayName.value,
                email: form.email.value
            };
            
            console.log('Sending profile update:', data);

            try {
                const response = await fetch('/auth/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('Profile update result:', result);
                
                if(result.success) {
                    location.reload(); 
                } else {
                    alert('Error: ' + (result.error || 'Failed to update profile'));
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch(e) {
                console.error('Save profile network error:', e);
                alert('Network error - check console for details');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        window.onclick = function(event) {
          const modal = document.getElementById('profileModal');
          if (event.target == modal) {
            closeProfileModal();
          }
        }
      </script>
      <% } %>

      <!-- Chat Window -->
      <div class="chat-window" id="chatWindow">
        <!-- Welcome Message -->
        <div class="message bot-message">
          <div class="message-avatar">
            <img src="/images/logo.jpg" alt="Bot Logo" />
          </div>
          <div class="message-content">
            <p>ðŸ‘‹ Hello! I'm your AI Assistant. How can I help you today?</p>
            <span class="message-time">Just now</span>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" id="typingIndicator" style="display: none">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      </div>

      <!-- Input Area -->
      <div class="chat-input-area">
        <form id="chatForm" class="chat-form">
          <input
            type="text"
            id="messageInput"
            class="message-input"
            placeholder="Type your message here..."
            autocomplete="off"
            maxlength="500"
            required
          />
          <button type="submit" class="send-button" id="sendButton">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z"
                fill="currentColor"
              />
            </svg>
          </button>
        </form>
      </div>
    </div>

    <!-- JavaScript -->
    <script src="/js/app.js"></script>
  </body>
</html>
